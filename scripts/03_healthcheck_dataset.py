# ============================================================
# MODULE: HealthCheck – Dataset Validation
# File: 03_healthcheck_dataset.py
# Purpose:
#   Validate raw datasets generated by Module B
#   Ensures schema consistency, data sanity and referential integrity
# ============================================================

import os
import sys
import pandas as pd
from datetime import date

# ============================================================
# PATHS & CONSTANTS
# ============================================================

RAW_DIR = os.path.join("output", "raw")

EXPECTED_FILES = {
    "clients.csv",
    "policies.csv",
    "claims.csv",
    "expenses.csv",
    "taxes.csv",
}

DATE_START = date(2023, 1, 1)
DATE_END = date(2025, 12, 31)

# ============================================================
# UTILITIES
# ============================================================

def fail(msg: str):
    print(f"[FAIL] {msg}")
    sys.exit(1)

def warn(msg: str):
    print(f"[WARN] {msg}")

def ok(msg: str):
    print(f"[OK] {msg}")

def load_csv(name: str) -> pd.DataFrame:
    path = os.path.join(RAW_DIR, name)
    if not os.path.exists(path):
        fail(f"Missing file: {name}")

    df = pd.read_csv(path)

    if df.empty:
        fail(f"{name} is empty")

    ok(f"{name}: loaded ({len(df)} rows)")
    return df


# ============================================================
# BASIC FILE CHECK
# ============================================================

def check_files():
    files = set(os.listdir(RAW_DIR))
    missing = EXPECTED_FILES - files

    if missing:
        fail(f"Missing CSV files: {missing}")

    ok("All expected CSV files present")

# ============================================================
# CLIENTS
# ============================================================

def check_clients(df: pd.DataFrame):
    required = {
        "client_id",
        "registration_year",
        "age",
        "gender",
        "state_code",
        "region_code",
        "market_tier",
        "customer_segment",
        "max_policies_allowed",
    }

    if not required.issubset(df.columns):
        fail("clients.csv missing required columns")

    if df["client_id"].duplicated().any():
        fail("Duplicate client_id detected")

    if not df["age"].between(18, 84).all():
        fail("Client age out of bounds")

    if not df["registration_year"].between(2023, 2025).all():
        fail("Invalid registration_year")

    ok("clients.csv validation passed")


# ============================================================
# POLICIES
# ============================================================

def check_policies(df: pd.DataFrame, clients: pd.DataFrame):
    required = {
        "policy_id",
        "policy_number",
        "client_id",
        "line_of_business",
        "plan_name",
        "state_code",
        "region_code",
        "effective_date",
        "expiration_date",
        "status",
        "is_renewal",
        "risk_score",
        "monthly_premium",
        "annual_premium",
    }

    if not required.issubset(df.columns):
        fail("policies.csv missing required columns")

    if df["policy_id"].duplicated().any():
        fail("Duplicate policy_id")

    if not df["risk_score"].between(1.0, 10.0).all():
        fail("risk_score out of bounds")

    if (df["monthly_premium"] <= 0).any():
        fail("monthly_premium must be positive")

    # FK: client_id
    missing_clients = set(df["client_id"]) - set(clients["client_id"])
    if missing_clients:
        fail("policies.csv contains client_id not in clients.csv")

    eff = pd.to_datetime(df["effective_date"])
    exp = pd.to_datetime(df["expiration_date"])

    if (eff > exp).any():
        fail("Policy effective_date > expiration_date")

    if eff.min().date() < DATE_START or exp.max().date() > DATE_END:
        fail("Policy dates outside allowed range")

    ok("policies.csv validation passed")


# ============================================================
# CLAIMS
# ============================================================

def check_claims(df: pd.DataFrame, policies: pd.DataFrame):
    required = {
        "claim_id",
        "policy_id",
        "incident_date",
        "report_date",
        "claim_type",
        "claim_amount_requested",
        "claim_amount_approved",
        "claim_amount_paid",
        "claim_status",
    }

    if not required.issubset(df.columns):
        fail("claims.csv missing required columns")

    if df["claim_id"].duplicated().any():
        fail("Duplicate claim_id")

    # FK: policy_id
    missing_policies = set(df["policy_id"]) - set(policies["policy_id"])
    if missing_policies:
        fail("claims.csv contains policy_id not in policies.csv")

    if (df["claim_amount_requested"] < 0).any():
        fail("Negative claim_amount_requested")

    if (df["claim_amount_paid"] > df["claim_amount_approved"]).any():
        fail("Paid amount greater than approved amount")

    inc = pd.to_datetime(df["incident_date"])
    rep = pd.to_datetime(df["report_date"])

    if inc.min().date() < DATE_START or inc.max().date() > DATE_END:
        fail("Incident dates outside allowed range")

    if (rep < inc).any():
        warn("Some claims reported before incident date")

    ok("claims.csv validation passed")


# ============================================================
# EXPENSES
# ============================================================

def check_expenses(df: pd.DataFrame):
    required = {
        "expense_id",
        "expense_category",
        "state_code",
        "region_code",
        "expense_month",
        "expense_amount",
    }

    if not required.issubset(df.columns):
        fail("expenses.csv missing required columns")

    if df["expense_id"].duplicated().any():
        fail("Duplicate expense_id")

    if (df["expense_amount"] < 0).any():
        fail("Negative expense_amount")

    months = pd.to_datetime(df["expense_month"])
    if months.min().date() < DATE_START or months.max().date() > DATE_END:
        fail("Expense dates outside allowed range")

    ok("expenses.csv validation passed")

# ============================================================
# TAXES
# ============================================================

def check_taxes(df: pd.DataFrame):
    required = {
        "tax_id",
        "policy_id",
        "state_code",
        "tax_amount",
        "tax_rate",
    }

    if not required.issubset(df.columns):
        fail("taxes.csv missing required columns")

    if df["tax_id"].duplicated().any():
        fail("Duplicate tax_id")

    if (df["tax_amount"] < 0).any():
        fail("Negative tax_amount")

    ok("taxes.csv validation passed")

# ============================================================
# SANITY CHECKS (MACRO)
# ============================================================

def check_sanity(policies: pd.DataFrame, claims: pd.DataFrame):
    ratio = len(claims) / len(policies)

    if not 0.10 <= ratio <= 0.50:
        warn(f"Claims-to-policies ratio unusual: {ratio:.2f}")

    renew_rate = policies["is_renewal"].mean()
    if not 0.05 <= renew_rate <= 0.35:
        warn(f"Renewal rate outside expected range: {renew_rate:.2f}")

    ok("Sanity checks completed")

# ============================================================
# RUN
# ============================================================

def main():
    print("HealthCheck Dataset — START")

    if not os.path.exists(RAW_DIR):
        fail("output/raw directory not found")

    check_files()

    clients = load_csv("clients.csv")
    policies = load_csv("policies.csv")
    claims = load_csv("claims.csv")
    expenses = load_csv("expenses.csv")
    taxes = load_csv("taxes.csv")

    check_clients(clients)
    check_policies(policies, clients)
    check_claims(claims, policies)
    check_expenses(expenses)
    check_taxes(taxes)
    check_sanity(policies, claims)

    print("HealthCheck Dataset — PASSED")

if __name__ == "__main__":
    main()
